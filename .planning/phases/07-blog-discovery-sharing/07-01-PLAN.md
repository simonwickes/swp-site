---
phase: 07-blog-discovery-sharing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/pages/api/posts.json.ts
  - src/components/blog/BlogDiscoveryBar.astro
  - package.json
autonomous: true

must_haves:
  truths:
    - "Build-time JSON endpoint serves all blog posts with searchable fields"
    - "BlogDiscoveryBar renders search input and filter pills following ServiceNav pattern"
    - "Filter pills include an 'All' pill plus category pills from services data and tag pills from all posts"
  artifacts:
    - path: "src/pages/api/posts.json.ts"
      provides: "Build-time search index JSON endpoint"
      exports: ["GET"]
      contains: "getCollection"
    - path: "src/components/blog/BlogDiscoveryBar.astro"
      provides: "Search input + filter pill bar component"
      contains: "filter-pill"
  key_links:
    - from: "src/pages/api/posts.json.ts"
      to: "astro:content"
      via: "getCollection('blog')"
      pattern: "getCollection.*blog"
    - from: "src/components/blog/BlogDiscoveryBar.astro"
      to: "src/data/services.ts"
      via: "import services for category pills"
      pattern: "import.*services"
---

<objective>
Install Fuse.js, create the build-time JSON search index endpoint, and build the BlogDiscoveryBar component with search input and filter pills.

Purpose: Provides the data layer (search index) and UI component (discovery bar) that the listing page integration (Plan 03) depends on. Without the JSON endpoint, client-side search has no data. Without the discovery bar, there is no search/filter UI.

Output: `/api/posts.json` endpoint generating searchable post data at build time, and a `BlogDiscoveryBar.astro` component with search input + category/tag filter pills styled after ServiceNav.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-blog-discovery-sharing/07-CONTEXT.md
@.planning/phases/07-blog-discovery-sharing/07-RESEARCH.md

@src/content.config.ts
@src/data/services.ts
@src/components/services/ServiceNav.astro
@src/pages/blog/[...page].astro
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Fuse.js and create search index endpoint</name>
  <files>package.json, src/pages/api/posts.json.ts</files>
  <action>
1. Install Fuse.js: `npm install fuse.js`

2. Create `src/pages/api/posts.json.ts` -- a static Astro endpoint that generates a JSON search index at build time.

The endpoint must:
- Import `getCollection` from `astro:content` and `getServiceBySlug` from `@/data/services`
- Export a `GET` handler (Astro static endpoint pattern)
- Fetch all blog posts via `getCollection("blog")`
- Sort posts by date descending (newest first)
- Map each post to a search-friendly object with these fields:
  - `id`: post.id (string)
  - `title`: post.data.title (string)
  - `category`: post.data.category (slug string, e.g., "outdoor-portraits")
  - `categoryTitle`: resolved display title from getServiceBySlug (e.g., "Outdoor Portraits")
  - `tags`: post.data.tags ?? [] (string array)
  - `date`: post.data.date.toISOString() (ISO string)
  - `excerpt`: post.body?.slice(0, 200) ?? "" (first 200 chars of body for content search)
- Return `new Response(JSON.stringify(searchData))` with `Content-Type: application/json` header

Follow the exact pattern from RESEARCH.md Pattern 1. This endpoint generates a static JSON file at `/api/posts.json` during build -- no runtime server needed.
  </action>
  <verify>
Run `npm run build` and confirm:
1. Build completes without errors
2. The output contains an `api/posts.json` file (check `dist/api/posts.json`)
3. The JSON contains an array of post objects with id, title, category, categoryTitle, tags, date, excerpt fields
  </verify>
  <done>
`/api/posts.json` is generated at build time containing all blog posts with searchable fields. Fuse.js is in package.json dependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create BlogDiscoveryBar component</name>
  <files>src/components/blog/BlogDiscoveryBar.astro</files>
  <action>
Create `src/components/blog/BlogDiscoveryBar.astro` -- a combined search input + filter pills bar.

Component requirements:
- Accept props: `categories` (array of {slug, title}), `tags` (string array of unique tags across all posts)
- Render a search input with placeholder "Search posts..." and a magnifying glass icon
- Render a horizontal scrollable pill row (following ServiceNav pattern with `overflow-x-auto [scrollbar-width:none] [&::-webkit-scrollbar]:hidden`)
- First pill is "All" with `data-filter="all"` -- always present, starts active (highlighted with accent colors)
- Category pills rendered from props, each with `data-filter="{slug}"` and `data-filter-type="category"`
- Tag pills rendered from props, each with `data-filter="{tag}"` and `data-filter-type="tag"`
- Tag pills should be visually distinct from category pills (e.g., prefixed with # or slightly different styling -- lighter background)
- A results count element: `<span class="results-count text-sm text-surface-500 dark:text-surface-400"></span>` (populated by JS in Plan 03)
- Search input should have `data-search-input` attribute for JS targeting
- Active pill style: `bg-accent-500 text-surface-50` (same as ServiceNav active)
- Inactive pill style: `text-surface-600 hover:bg-surface-100 hover:text-accent-500 dark:text-surface-400 dark:hover:bg-surface-800 dark:hover:text-accent-400`

Use class selectors (not IDs) per project convention (03-03 decision). The component only renders HTML/CSS -- all interactivity is handled by the client-side script in Plan 03.

Layout: search input on top, pill row below it, results count below pills. All within a `mb-8` container.
  </action>
  <verify>
1. File exists at `src/components/blog/BlogDiscoveryBar.astro`
2. Component renders search input, "All" pill, category pills, and tag pills
3. `npm run build` succeeds with the new component (even though it is not yet used in a page -- just confirm no syntax errors)
  </verify>
  <done>
BlogDiscoveryBar component exists with search input, "All" pill, category pills from services data, and tag pills -- all with data attributes for JS targeting. Styled consistently with ServiceNav pill pattern.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `dist/api/posts.json` exists and contains valid JSON with post data
3. `src/components/blog/BlogDiscoveryBar.astro` exists with search input + filter pills
4. Fuse.js appears in `package.json` dependencies
</verification>

<success_criteria>
- Build-time JSON search index generates at `/api/posts.json` with all blog post data
- BlogDiscoveryBar component renders search input and category/tag filter pills
- Fuse.js installed and available for import
- All pills use data attributes for JS targeting (Plan 03 will add interactivity)
</success_criteria>

<output>
After completion, create `.planning/phases/07-blog-discovery-sharing/07-01-SUMMARY.md`
</output>
