---
phase: 01-foundation-design-system
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/assets/images/test/sample.jpg
  - src/pages/image-test.astro
autonomous: true

must_haves:
  truths:
    - "Astro Image component generates responsive srcset in build output"
    - "Astro Picture component generates multiple formats (avif, webp, jpg) in build output"
    - "Images in src/assets/ are optimized during build (not served raw)"
  artifacts:
    - path: "src/pages/image-test.astro"
      provides: "Test page proving image pipeline works"
      contains: "astro:assets"
    - path: "src/assets/images/test/sample.jpg"
      provides: "Test image for pipeline verification"
  key_links:
    - from: "src/pages/image-test.astro"
      to: "src/assets/images/test/sample.jpg"
      via: "import and Image/Picture component usage"
      pattern: "import.*assets/images"
    - from: "src/pages/image-test.astro"
      to: "astro:assets"
      via: "Image and Picture component imports"
      pattern: "import.*astro:assets"
---

<objective>
Prove that Astro's image optimization pipeline works correctly by creating a test page that uses both the Image and Picture components with a real photograph, then verifying the build output contains optimized formats and responsive srcset attributes.

Purpose: The image pipeline is the backbone of a photography portfolio site. Every future phase depends on images being automatically optimized (resized, format-converted, quality-adjusted) at build time. This plan proves the pipeline before any gallery work begins. If the pipeline has issues, they surface here -- not in Phase 3 when 100+ images are involved.

Output: A test page at /image-test/ demonstrating Image (constrained layout with srcset) and Picture (multi-format avif/webp/jpg) components. Build output proves optimization is happening.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-design-system/01-RESEARCH.md
@.planning/phases/01-foundation-design-system/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Image pipeline test with Image and Picture components</name>
  <files>
    src/assets/images/test/sample.jpg
    src/pages/image-test.astro
  </files>
  <action>
    First, obtain a test image. Create or download a sample JPEG photograph to use as the test image at src/assets/images/test/sample.jpg. Options:
    - Use a placeholder image generator: `curl -L "https://picsum.photos/2400/1600" -o src/assets/images/test/sample.jpg`
    - Or create a simple test image using ImageMagick if available: `convert -size 2400x1600 gradient:sienna-peru src/assets/images/test/sample.jpg`
    - The image should be large enough to test downscaling (at least 1600px wide)
    - It MUST be a real image file (JPEG), not a placeholder SVG or text file

    Create src/pages/image-test.astro:
    ```astro
    ---
    import BaseLayout from '../layouts/BaseLayout.astro';
    import { Image, Picture } from 'astro:assets';
    import testImage from '../assets/images/test/sample.jpg';
    ---

    <BaseLayout title="Image Pipeline Test">
      <main class="mx-auto max-w-4xl px-4 py-12">
        <h1 class="mb-8 font-display text-3xl font-bold">Image Pipeline Test</h1>

        <section class="mb-12">
          <h2 class="mb-4 font-display text-xl font-semibold">Image Component (Constrained)</h2>
          <p class="mb-4 text-surface-500">Should generate responsive srcset, constrained to 800px max width.</p>
          <Image
            src={testImage}
            alt="Test image - constrained layout"
            width={800}
            quality={80}
          />
        </section>

        <section class="mb-12">
          <h2 class="mb-4 font-display text-xl font-semibold">Picture Component (Multi-format)</h2>
          <p class="mb-4 text-surface-500">Should generate avif + webp + jpeg fallback sources.</p>
          <Picture
            src={testImage}
            formats={['avif', 'webp']}
            alt="Test image - multi-format"
            width={1200}
            quality={85}
          />
        </section>

        <section class="mb-12">
          <h2 class="mb-4 font-display text-xl font-semibold">Small Thumbnail</h2>
          <p class="mb-4 text-surface-500">Should generate a small optimized thumbnail.</p>
          <Image
            src={testImage}
            alt="Test image - thumbnail"
            width={300}
            quality={75}
            class="rounded-lg"
          />
        </section>
      </main>
    </BaseLayout>
    ```

    Use BaseLayout directly (not PageLayout) since this is a test page that will be removed later. If PageLayout exists from Plan 02, either works fine.

    IMPORTANT: Import the image from `src/assets/` (not `public/`). Images in `public/` bypass the optimization pipeline entirely. The import path must be a relative path to the file in src/assets/.

    IMPORTANT: Do NOT install sharp manually -- it is included as an Astro dependency. If the build fails with a sharp error, run `npm install sharp` to resolve.
  </action>
  <verify>
    1. `npm run build` completes without errors
    2. Inspect the build output HTML for the image-test page:
       ```bash
       cat dist/image-test/index.html
       ```
    3. Verify the Image component output contains:
       - An `<img>` tag with a `srcset` attribute containing multiple sizes OR a `src` pointing to an optimized file (not the original)
       - The image path should be in `/_astro/` directory (Astro's optimized output path)
       - Width attribute respecting the specified constraint (800px)
    4. Verify the Picture component output contains:
       - A `<picture>` element with `<source>` tags
       - At least one `<source>` with `type="image/avif"`
       - At least one `<source>` with `type="image/webp"`
       - A fallback `<img>` tag
    5. Check that optimized image files exist in dist/_astro/:
       ```bash
       ls -la dist/_astro/*.{avif,webp,jpg} 2>/dev/null | head -20
       ```
    6. Verify file sizes are smaller than the original (optimization is happening, not just copying)
    7. `npm run dev` -- the test page loads at http://localhost:4321/image-test/ with visible images
  </verify>
  <done>
    Image pipeline proven: Image component generates optimized output with correct width constraints. Picture component generates avif + webp + jpeg fallback sources. Build output contains optimized files in /_astro/ that are smaller than the source. The pipeline is ready for production use with portfolio images.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with image optimization
2. Build output HTML contains responsive srcset OR optimized image paths
3. Build output HTML contains `<picture>` with avif/webp/jpeg sources
4. Optimized images exist in dist/_astro/ at smaller file sizes than originals
5. Test page renders correctly in dev mode with visible images
</verification>

<success_criteria>
- Test image exists in src/assets/images/test/ (real JPEG, not placeholder)
- Image component produces optimized constrained output
- Picture component produces multi-format (avif, webp, jpg) output
- Build output confirms optimization is active (files in _astro/, smaller than source)
- Pipeline pattern proven and documented for future phase use
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-design-system/01-03-SUMMARY.md`
</output>
