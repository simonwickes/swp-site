---
phase: 04-contact-conversion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - astro.config.mjs
  - package.json
  - src/actions/index.ts
  - .env
autonomous: true
user_setup:
  - service: resend
    why: "Email delivery for contact form notifications"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard (resend.com) -> API Keys -> Create API Key"
      - name: CONTACT_EMAIL
        source: "Simon's email address for receiving contact form submissions"
    dashboard_config:
      - task: "Create Resend account and generate API key"
        location: "https://resend.com/signup"

must_haves:
  truths:
    - "Astro Actions server endpoint exists and accepts form submissions"
    - "Zod validation rejects invalid input with field-level errors"
    - "Resend SDK sends notification email to Simon and confirmation to submitter"
  artifacts:
    - path: "astro.config.mjs"
      provides: "Netlify adapter + env schema for RESEND_API_KEY and CONTACT_EMAIL"
      contains: "adapter: netlify()"
    - path: "src/actions/index.ts"
      provides: "submitContact action with Zod validation and Resend email delivery"
      exports: ["server"]
    - path: ".env"
      provides: "Local development environment variables"
      contains: "RESEND_API_KEY"
  key_links:
    - from: "src/actions/index.ts"
      to: "astro:env/server"
      via: "type-safe env import"
      pattern: "import.*RESEND_API_KEY.*from.*astro:env/server"
    - from: "src/actions/index.ts"
      to: "resend"
      via: "Resend SDK email send"
      pattern: "resend\\.emails\\.send"
---

<objective>
Install Netlify adapter and Resend SDK, configure Astro for server-side actions with type-safe environment variables, and implement the contact form server action with Zod validation and dual email delivery (notification to Simon + confirmation to submitter).

Purpose: This is the server-side foundation for the contact form. Without the adapter and action, the form UI has nothing to submit to. This plan converts the project from purely static to static-with-serverless, enabling the Resend email integration.
Output: Working Astro Action endpoint that validates form data and sends emails via Resend.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-contact-conversion/04-RESEARCH.md
@.planning/phases/04-contact-conversion/04-CONTEXT.md
@astro.config.mjs
@src/data/services.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Netlify adapter + Resend SDK, configure Astro</name>
  <files>astro.config.mjs, package.json, .env</files>
  <action>
1. Install dependencies:
   ```bash
   npx astro add netlify
   npm install resend
   ```
   The `astro add netlify` command will automatically update astro.config.mjs with the adapter import and configuration. If it prompts, accept all defaults.

2. After `astro add netlify` runs, manually verify and adjust `astro.config.mjs` to match this structure:
   ```javascript
   import { defineConfig, envField } from "astro/config";
   import tailwindcss from "@tailwindcss/vite";
   import netlify from "@astrojs/netlify";

   export default defineConfig({
     site: "https://simonwickes.com",
     adapter: netlify(),
     build: {
       format: "directory",
     },
     env: {
       schema: {
         RESEND_API_KEY: envField.string({
           context: "server",
           access: "secret",
         }),
         CONTACT_EMAIL: envField.string({
           context: "server",
           access: "secret",
         }),
       },
     },
     vite: {
       plugins: [tailwindcss()],
     },
   });
   ```
   IMPORTANT: Remove `output: "static"` if present -- Astro 5 defaults to static and the adapter handles server-rendered endpoints automatically. Keep the `// @ts-check` comment at top if it was there before.

3. Create `.env` file in project root with placeholder values for local development:
   ```
   RESEND_API_KEY=re_placeholder_key
   CONTACT_EMAIL=simon@example.com
   ```

4. Verify `.env` is in `.gitignore`. If not, add it.

5. Run `npm run build` to confirm the adapter is configured correctly and the build succeeds. Fix any issues.
  </action>
  <verify>
- `npm run build` completes without errors
- `astro.config.mjs` contains `adapter: netlify()` and `env.schema` with both env vars
- `.env` file exists with RESEND_API_KEY and CONTACT_EMAIL
- `.gitignore` includes `.env`
- `package.json` includes `@astrojs/netlify` and `resend` in dependencies
  </verify>
  <done>Astro is configured with Netlify adapter and type-safe env schema. Build succeeds. Local .env file exists for development.</done>
</task>

<task type="auto">
  <name>Task 2: Create contact form Astro Action with Zod validation and Resend emails</name>
  <files>src/actions/index.ts</files>
  <action>
Create `src/actions/index.ts` implementing the `submitContact` action:

```typescript
import { defineAction, ActionError } from 'astro:actions';
import { z } from 'astro/zod';
import { Resend } from 'resend';
import { RESEND_API_KEY, CONTACT_EMAIL } from 'astro:env/server';

const resend = new Resend(RESEND_API_KEY);

export const server = {
  submitContact: defineAction({
    accept: 'form',
    input: z.object({
      name: z.string().min(1, 'Name is required'),
      email: z.string().email('Please enter a valid email address'),
      message: z.string().min(10, 'Please include a message (at least 10 characters)'),
      eventType: z.string().optional(),
      eventTypeOther: z.string().optional(),
      eventDate: z.string().optional(),
    }),
    handler: async (input) => {
      // ... implementation below
    },
  }),
};
```

Handler implementation details:
- Resolve event type: if `eventType === 'other'`, use `eventTypeOther` value; otherwise use `eventType` value; default to `'Not specified'` if empty.
- Send notification email to Simon (CONTACT_EMAIL) first:
  - `from`: `'Simon Wickes Photography <onboarding@resend.dev>'` (use Resend dev sender during development -- change to custom domain after DNS verification)
  - `to`: `[CONTACT_EMAIL]`
  - `replyTo`: submitter's email address
  - `subject`: `New inquiry from {name}`
  - `html`: Clean, simple HTML with inline styles. Include: name, email, event type, event date, and the full message. Use `<br>` for message line breaks. No complex template -- just a formatted list of details.
- Send confirmation email to submitter second:
  - `from`: same as above
  - `to`: `[email]` (submitter's address)
  - `subject`: `'Thanks for reaching out!'`
  - `html`: Friendly message thanking them, confirming receipt, stating "I'll get back to you within 24-48 hours", linking to simonwickes.com. Keep it short and warm.
- Wrap both sends in try/catch. If the notification email succeeds but confirmation fails, still return success (Simon has the inquiry -- that is what matters). Only throw ActionError if the notification to Simon fails.
- On success: return `{ success: true }`
- On notification failure: throw `ActionError` with code `'INTERNAL_SERVER_ERROR'` and a user-friendly message.

IMPORTANT:
- Import `z` from `'astro/zod'` (NOT `'astro:schema'` which is deprecated)
- Use `accept: 'form'` (NOT json) since form uses FormData
- Use `onboarding@resend.dev` as the from address (development safe sender)
  </action>
  <verify>
- `npm run build` completes without errors (action compiles and is recognized by Astro)
- File exists at `src/actions/index.ts`
- File imports from `astro:actions`, `astro/zod`, `resend`, and `astro:env/server`
- Exported `server.submitContact` uses `accept: 'form'` and has Zod input schema
- Handler sends two emails via `resend.emails.send()`
  </verify>
  <done>Astro Action endpoint exists at src/actions/index.ts. It validates 5 form fields with Zod, sends notification email to CONTACT_EMAIL and confirmation to submitter via Resend SDK. Build passes.</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds with Netlify adapter configured
- `src/actions/index.ts` exists and exports `server.submitContact`
- `astro.config.mjs` has adapter, env schema with both secret vars
- `.env` exists with placeholder values for local dev
</verification>

<success_criteria>
- Netlify adapter installed and configured in astro.config.mjs
- Resend SDK installed and imported in action
- Type-safe env vars (RESEND_API_KEY, CONTACT_EMAIL) defined in env schema
- submitContact action validates name, email, message, eventType, eventTypeOther, eventDate
- Action sends notification email to Simon and confirmation to submitter
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/04-contact-conversion/04-01-SUMMARY.md`
</output>
