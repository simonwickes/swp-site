---
import {
  Astronav,
  MenuItems,
  Dropdown,
  DropdownItems,
  StickyHeader,
} from "astro-navbar";
import ThemeToggle from "./ThemeToggle.astro";

const currentPath = Astro.url.pathname;

interface NavLink {
  label: string;
  href: string;
}

interface NavGroup {
  heading: string;
  links: NavLink[];
}

const serviceGroups: NavGroup[] = [
  {
    heading: "People",
    links: [
      { label: "Events", href: "/services/events/" },
      { label: "Live Performances", href: "/services/live-performances/" },
      { label: "Outdoor Portraits", href: "/services/outdoor-portraits/" },
      { label: "Weddings", href: "/services/weddings/" },
    ],
  },
  {
    heading: "Places",
    links: [{ label: "Landscape", href: "/services/landscape/" }],
  },
  {
    heading: "Things",
    links: [
      { label: "Assignments", href: "/services/assignments/" },
      { label: "Cars", href: "/services/cars/" },
      { label: "Commercial", href: "/services/commercial/" },
    ],
  },
];

const allServiceLinks = serviceGroups.flatMap((g) => g.links);
const isServicePage = allServiceLinks.some((l) => currentPath === l.href);

function isActive(href: string): boolean {
  return currentPath === href;
}
---

<StickyHeader
  class="sticky top-0 z-50 w-full border-b transition-all"
  scrollY={50}
  defaultClass="py-4 border-transparent bg-bg-light dark:bg-bg-dark"
  activeClass="py-2 border-surface-200 dark:border-surface-800 bg-bg-light/80 dark:bg-bg-dark/80 backdrop-blur-lg"
>
  <nav class="mx-auto max-w-7xl px-4">
    <!-- Desktop Navigation (uses astro-navbar) -->
    <div class="hidden lg:block">
      <Astronav>
        <div class="flex items-center justify-between">
          <a
            href="/"
            class="font-display text-xl font-bold tracking-tight transition-colors hover:text-accent-500"
          >
            Simon Wickes Photography
          </a>
          <div class="flex items-center gap-1">
            <MenuItems class="flex items-center">
              <ul class="flex items-center gap-1">
                <li>
                  <a
                    href="/"
                    class:list={[
                      "rounded-lg px-3 py-2 text-sm font-medium transition-colors hover:text-accent-500",
                      isActive("/")
                        ? "text-accent-500"
                        : "text-surface-600 dark:text-surface-400",
                    ]}
                  >
                    Home
                  </a>
                </li>
                <li>
                  <Dropdown class="group relative">
                    <button
                      class:list={[
                        "flex items-center gap-1 rounded-lg px-3 py-2 text-sm font-medium transition-colors hover:text-accent-500",
                        isServicePage
                          ? "text-accent-500"
                          : "text-surface-600 dark:text-surface-400",
                      ]}
                    >
                      <span>Services</span>
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="2.5"
                        stroke="currentColor"
                        class="mt-0.5 h-3.5 w-3.5 transition-transform group-open:rotate-180"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M19.5 8.25l-7.5 7.5-7.5-7.5"></path>
                      </svg>
                    </button>
                    <DropdownItems>
                      <div
                        class="absolute left-0 top-2 z-50 grid w-[560px] grid-cols-3 gap-8 rounded-lg border border-surface-200 bg-bg-light p-6 shadow-lg dark:border-surface-800 dark:bg-bg-dark"
                      >
                        {
                          serviceGroups.map((group) => (
                            <div>
                              <h3 class="mb-2 text-xs font-semibold uppercase tracking-wider text-surface-500">
                                {group.heading}
                              </h3>
                              <ul class="space-y-1">
                                {group.links.map((link) => (
                                  <li>
                                    <a
                                      href={link.href}
                                      class:list={[
                                        "block whitespace-nowrap rounded px-2 py-1.5 text-sm transition-colors hover:text-accent-500",
                                        isActive(link.href)
                                          ? "text-accent-500"
                                          : "text-surface-600 dark:text-surface-400",
                                      ]}
                                    >
                                      {link.label}
                                    </a>
                                  </li>
                                ))}
                              </ul>
                            </div>
                          ))
                        }
                      </div>
                    </DropdownItems>
                  </Dropdown>
                </li>
                <li>
                  <a
                    href="/galleries/"
                    class:list={[
                      "rounded-lg px-3 py-2 text-sm font-medium transition-colors hover:text-accent-500",
                      isActive("/galleries/")
                        ? "text-accent-500"
                        : "text-surface-600 dark:text-surface-400",
                    ]}
                  >
                    Client Galleries
                  </a>
                </li>
                <li>
                  <a
                    href="/blog"
                    class:list={[
                      "rounded-lg px-3 py-2 text-sm font-medium transition-colors hover:text-accent-500",
                      currentPath.startsWith("/blog")
                        ? "text-accent-500"
                        : "text-surface-600 dark:text-surface-400",
                    ]}
                  >
                    Blog
                  </a>
                </li>
                <li>
                  <a
                    href="/faq/"
                    class:list={[
                      "rounded-lg px-3 py-2 text-sm font-medium transition-colors hover:text-accent-500",
                      isActive("/faq/")
                        ? "text-accent-500"
                        : "text-surface-600 dark:text-surface-400",
                    ]}
                  >
                    FAQ
                  </a>
                </li>
                <li>
                  <a
                    href="/contact/"
                    class:list={[
                      "rounded-lg px-3 py-2 text-sm font-medium transition-colors hover:text-accent-500",
                      isActive("/contact/")
                        ? "text-accent-500"
                        : "text-surface-600 dark:text-surface-400",
                    ]}
                  >
                    Contact
                  </a>
                </li>
              </ul>
            </MenuItems>
            <div class="ml-2">
              <ThemeToggle />
            </div>
          </div>
        </div>
      </Astronav>
    </div>

    <!-- Mobile Navigation (custom implementation for slide-in panel) -->
    <div class="lg:hidden">
      <div class="flex items-center justify-between">
        <a
          href="/"
          class="font-display text-xl font-bold tracking-tight transition-colors hover:text-accent-500"
        >
          Simon Wickes Photography
        </a>
        <button
          id="mobile-menu-toggle"
          type="button"
          aria-label="Open navigation menu"
          aria-expanded="false"
          class="rounded-lg p-2 transition-colors hover:bg-surface-200 dark:hover:bg-surface-800"
        >
          <!-- Hamburger icon -->
          <svg
            class="h-6 w-6"
            fill="currentColor"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              fill-rule="evenodd"
              d="M4 5h16a1 1 0 010 2H4a1 1 0 110-2zm0 6h16a1 1 0 010 2H4a1 1 0 010-2zm0 6h16a1 1 0 010 2H4a1 1 0 010-2z"
            ></path>
          </svg>
        </button>
      </div>
    </div>
  </nav>
</StickyHeader>

<!-- Mobile slide-in overlay -->
<div
  id="mobile-menu-overlay"
  class="fixed inset-0 z-40 bg-black/50 opacity-0 pointer-events-none transition-opacity duration-300 lg:hidden"
  aria-hidden="true"
>
</div>

<!-- Mobile slide-in panel -->
<nav
  id="mobile-menu-panel"
  class="fixed top-0 right-0 bottom-0 z-50 w-4/5 max-w-[320px] translate-x-full transform overflow-y-auto bg-bg-light transition-transform duration-300 ease-in-out dark:bg-bg-dark lg:hidden"
  aria-label="Mobile navigation"
  aria-hidden="true"
>
  <div class="flex flex-col p-6">
    <!-- Panel header with close button -->
    <div class="mb-6 flex items-center justify-between">
      <span class="font-display text-lg font-bold">Menu</span>
      <button
        id="mobile-menu-close"
        type="button"
        aria-label="Close navigation menu"
        class="rounded-lg p-2 transition-colors hover:bg-surface-200 dark:hover:bg-surface-800"
      >
        <svg
          class="h-6 w-6"
          fill="currentColor"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            fill-rule="evenodd"
            clip-rule="evenodd"
            d="M18.278 16.864a1 1 0 01-1.414 1.414l-4.829-4.828-4.828 4.828a1 1 0 01-1.414-1.414l4.828-4.829-4.828-4.828a1 1 0 011.414-1.414l4.829 4.828 4.828-4.828a1 1 0 111.414 1.414l-4.828 4.829 4.828 4.828z"
          ></path>
        </svg>
      </button>
    </div>

    <!-- Main nav links -->
    <a
      href="/"
      class:list={[
        "mb-2 rounded-lg px-3 py-2.5 text-base font-medium transition-colors hover:text-accent-500",
        isActive("/")
          ? "text-accent-500"
          : "text-surface-700 dark:text-surface-300",
      ]}
    >
      Home
    </a>

    <!-- Service groups -->
    <div class="mb-2 mt-4 border-t border-surface-200 pt-4 dark:border-surface-800">
      <span
        class="mb-1 block px-3 text-xs font-semibold uppercase tracking-wider text-surface-500"
      >
        Services
      </span>
    </div>

    {
      serviceGroups.map((group) => (
        <div class="mb-4">
          <h3 class="mb-1 px-3 text-xs font-semibold uppercase tracking-wider text-surface-400 dark:text-surface-600">
            {group.heading}
          </h3>
          {group.links.map((link) => (
            <a
              href={link.href}
              class:list={[
                "block rounded-lg px-3 py-2 text-sm transition-colors hover:text-accent-500",
                isActive(link.href)
                  ? "text-accent-500"
                  : "text-surface-600 dark:text-surface-400",
              ]}
            >
              {link.label}
            </a>
          ))}
        </div>
      ))
    }

    <!-- Client Galleries link -->
    <div class="border-t border-surface-200 pt-4 dark:border-surface-800">
      <a
        href="/galleries/"
        class:list={[
          "block rounded-lg px-3 py-2.5 text-base font-medium transition-colors hover:text-accent-500",
          isActive("/galleries/")
            ? "text-accent-500"
            : "text-surface-700 dark:text-surface-300",
        ]}
      >
        Client Galleries
      </a>
    </div>

    <!-- Blog link -->
    <div class="border-t border-surface-200 pt-4 dark:border-surface-800">
      <a
        href="/blog"
        class:list={[
          "block rounded-lg px-3 py-2.5 text-base font-medium transition-colors hover:text-accent-500",
          currentPath.startsWith("/blog")
            ? "text-accent-500"
            : "text-surface-700 dark:text-surface-300",
        ]}
      >
        Blog
      </a>
    </div>

    <!-- FAQ link -->
    <div class="border-t border-surface-200 pt-4 dark:border-surface-800">
      <a
        href="/faq/"
        class:list={[
          "block rounded-lg px-3 py-2.5 text-base font-medium transition-colors hover:text-accent-500",
          isActive("/faq/")
            ? "text-accent-500"
            : "text-surface-700 dark:text-surface-300",
        ]}
      >
        FAQ
      </a>
    </div>

    <!-- Contact link -->
    <div class="border-t border-surface-200 pt-4 dark:border-surface-800">
      <a
        href="/contact/"
        class:list={[
          "block rounded-lg px-3 py-2.5 text-base font-medium transition-colors hover:text-accent-500",
          isActive("/contact/")
            ? "text-accent-500"
            : "text-surface-700 dark:text-surface-300",
        ]}
      >
        Contact
      </a>
    </div>

    <!-- Theme toggle -->
    <div
      class="mt-6 flex items-center gap-2 border-t border-surface-200 px-3 pt-4 dark:border-surface-800"
    >
      <span class="text-sm text-surface-500">Theme</span>
      <ThemeToggle />
    </div>
  </div>
</nav>

<script>
  function initMobileMenu() {
    const toggle = document.getElementById("mobile-menu-toggle");
    const close = document.getElementById("mobile-menu-close");
    const overlay = document.getElementById("mobile-menu-overlay");
    const panel = document.getElementById("mobile-menu-panel");

    if (!toggle || !close || !overlay || !panel) return;

    function openMenu() {
      panel!.classList.remove("translate-x-full");
      panel!.classList.add("translate-x-0");
      overlay!.classList.remove("opacity-0", "pointer-events-none");
      overlay!.classList.add("opacity-100", "pointer-events-auto");
      toggle!.setAttribute("aria-expanded", "true");
      panel!.setAttribute("aria-hidden", "false");
      overlay!.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
    }

    function closeMenu() {
      panel!.classList.remove("translate-x-0");
      panel!.classList.add("translate-x-full");
      overlay!.classList.remove("opacity-100", "pointer-events-auto");
      overlay!.classList.add("opacity-0", "pointer-events-none");
      toggle!.setAttribute("aria-expanded", "false");
      panel!.setAttribute("aria-hidden", "true");
      overlay!.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
    }

    // Clone to remove old listeners
    const newToggle = toggle.cloneNode(true) as HTMLElement;
    toggle.parentNode?.replaceChild(newToggle, toggle);
    const newClose = close.cloneNode(true) as HTMLElement;
    close.parentNode?.replaceChild(newClose, close);
    const newOverlay = overlay.cloneNode(true) as HTMLElement;
    overlay.parentNode?.replaceChild(newOverlay, overlay);

    // Re-get references after cloning
    const toggleBtn = document.getElementById("mobile-menu-toggle")!;
    const closeBtn = document.getElementById("mobile-menu-close")!;
    const overlayEl = document.getElementById("mobile-menu-overlay")!;

    toggleBtn.addEventListener("click", openMenu);
    closeBtn.addEventListener("click", closeMenu);
    overlayEl.addEventListener("click", closeMenu);

    // Close on link click inside panel
    const panelLinks = panel.querySelectorAll("a");
    panelLinks.forEach((link) => {
      link.addEventListener("click", closeMenu);
    });

    // Close on Escape key
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && !panel.classList.contains("translate-x-full")) {
        closeMenu();
      }
    });
  }

  initMobileMenu();
  document.addEventListener("astro:after-swap", initMobileMenu);
</script>
